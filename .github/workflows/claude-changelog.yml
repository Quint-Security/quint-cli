name: Changelog

on:
  push:
    tags:
      - 'v*'

jobs:
  changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous tag
        id: tags
        run: |
          CURRENT="${{ github.ref_name }}"
          PREVIOUS=$(git tag --sort=-version:refname | grep -v "^${CURRENT}$" | head -n1)
          echo "current=${CURRENT}" >> $GITHUB_OUTPUT
          echo "previous=${PREVIOUS}" >> $GITHUB_OUTPUT

      - name: Checkout skills
        uses: actions/checkout@v4
        with:
          repository: Quint-Security/skills
          path: /tmp/skills
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Write MCP config
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          python3 -c "
          import json, os
          config = {
            'mcpServers': {
              'notionApi': {
                'command': 'npx',
                'args': ['-y', '@notionhq/notion-mcp-server'],
                'env': {
                  'OPENAPI_MCP_HEADERS': json.dumps({
                    'Authorization': 'Bearer ' + os.environ['NOTION_TOKEN'],
                    'Notion-Version': '2022-06-28'
                  })
                }
              }
            }
          }
          print(json.dumps(config, indent=2))
          " > /tmp/mcp-config.json

      - name: Run changelog agent
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SKILL=$(cat /tmp/skills/changelog-documentation/SKILL.md)
          CURR="${{ steps.tags.outputs.current }}"
          PREV="${{ steps.tags.outputs.previous }}"
          TODAY=$(date -u +%Y-%m-%d)

          claude --print \
            --mcp-config /tmp/mcp-config.json \
            --allowedTools "Bash(git log:*),Bash(git tag:*),Bash(gh pr list:*),Bash(gh pr view:*)" \
            -p "$SKILL

          ---

          Apply the above guidelines to generate and publish a changelog entry.

          Release details:
          - Repository: ${{ github.repository }}
          - Version: $CURR
          - Previous version: ${PREV:-none (first release)}
          - Target Notion page ID: 30e0b8d3f136801d9a8ed983e24ecc41

          1. Review commits: git log ${PREV:+${PREV}..}${CURR} --oneline --no-merges
          2. Review merged PRs: gh pr list --state merged
          3. Categorize and write entries per the skill guidelines above
          4. Search Notion to confirm no duplicate entry for $CURR under page ID 30e0b8d3f136801d9a8ed983e24ecc41
          5. Create a new child page under page ID 30e0b8d3f136801d9a8ed983e24ecc41 titled '$CURR â€” $TODAY'"
