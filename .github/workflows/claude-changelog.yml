name: Changelog

on:
  push:
    tags:
      - 'v*'

jobs:
  changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get previous tag
        id: tags
        run: |
          CURRENT="${{ github.ref_name }}"
          PREVIOUS=$(git tag --sort=-version:refname | grep -v "^${CURRENT}$" | head -n1)
          echo "current=${CURRENT}" >> $GITHUB_OUTPUT
          echo "previous=${PREVIOUS}" >> $GITHUB_OUTPUT

      - name: Checkout skills
        uses: actions/checkout@v4
        with:
          repository: Quint-Security/skills
          path: _skills
          token: ${{ secrets.GH_PAT }}

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Write MCP config
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          python3 -c "
          import json, os
          config = {
            'mcpServers': {
              'notionApi': {
                'command': 'npx',
                'args': ['-y', '@notionhq/notion-mcp-server'],
                'env': {
                  'OPENAPI_MCP_HEADERS': json.dumps({
                    'Authorization': 'Bearer ' + os.environ['NOTION_TOKEN'],
                    'Notion-Version': '2022-06-28'
                  })
                }
              }
            }
          }
          print(json.dumps(config, indent=2))
          " > /tmp/mcp-config.json

      - name: Build prompt
        env:
          CURR: ${{ steps.tags.outputs.current }}
          PREV: ${{ steps.tags.outputs.previous }}
          REPO: ${{ github.repository }}
        run: |
          python3 - << 'PYEOF'
          import re, os

          skill = open('_skills/changelog-documentation/SKILL.md').read()
          skill = re.sub(r'^---\n.*?\n---\n', '', skill, count=1, flags=re.DOTALL)

          curr = os.environ['CURR']
          prev = os.environ.get('PREV') or 'none (first release)'
          repo = os.environ['REPO']
          page_id = '30e0b8d3f136801d9a8ed983e24ecc41'
          git_range = f'{prev}..{curr}' if prev != 'none (first release)' else curr

          import subprocess
          today = subprocess.check_output(['date', '-u', '+%Y-%m-%d']).decode().strip()

          prompt = f"""{skill}

          ---

          Apply the above guidelines to generate and publish a changelog entry.

          Release details:
          - Repository: {repo}
          - Version: {curr}
          - Previous version: {prev}
          - Target Notion page ID: {page_id}

          1. Review commits: git log {git_range} --oneline --no-merges
          2. Review merged PRs: gh pr list --state merged
          3. Categorize and write entries per the skill guidelines above
          4. Use notion-search to find the 'Changelog Repository' inline database inside page ID {page_id}
          5. Check that database for any existing entry named '{curr}' to avoid duplicates
          6. Create a new entry in that database with these properties:
             - Name: '{curr} â€” {today}'
             - Tag: '{curr}'
             - Brief Description: one sentence summary of the most important change in this release
             - Github Link: https://github.com/{repo}/releases/tag/{curr}
             - Created At: '{today}'
             Before creating the page, check the database for any template pages and use the default template as the base structure for the new entry body.
             The full categorized changelog content goes in the body of the new database page, following the template structure.
          """

          with open('/tmp/prompt.txt', 'w') as f:
              f.write(prompt)
          PYEOF

      - name: Set up Claude credentials
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          mkdir -p ~/.claude
          python3 -c "import json,os; open(os.path.expanduser('~/.claude/.credentials.json'), 'w').write(json.dumps({'claudeAiOAuthToken': os.environ['CLAUDE_CODE_OAUTH_TOKEN']}))"

      - name: Run changelog agent
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          claude --print \
            --dangerously-skip-permissions \
            --mcp-config /tmp/mcp-config.json \
            --allowedTools "Bash(git log:*),Bash(git tag:*),Bash(gh pr list:*),Bash(gh pr view:*)" \
            < /tmp/prompt.txt
