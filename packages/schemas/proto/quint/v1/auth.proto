syntax = "proto3";

package quint.v1;

option go_package = "github.com/Quint-Security/quint/gen/quint/v1";

import "google/protobuf/timestamp.proto";

// ── Passkey / WebAuthn ──────────────────────────────────────────
// Primary auth method for interactive users.

message PasskeyChallenge {
  string challenge        = 1;   // Base64url-encoded random challenge
  string rp_id            = 2;   // Relying party ID (e.g. "quint.security")
  string rp_name          = 3;   // Display name
  string user_id          = 4;   // Opaque user handle
  string user_display_name = 5;
  int32  timeout_ms       = 6;   // Challenge expiry (default 60000)
}

message PasskeyCredential {
  string credential_id    = 1;   // Base64url-encoded credential ID
  bytes  public_key       = 2;   // COSE public key
  string attestation      = 3;   // Attestation format
  bytes  authenticator_data = 4;
  bytes  client_data_json = 5;
  bytes  signature        = 6;
}

message PasskeyVerifyRequest {
  string challenge        = 1;   // Original challenge
  PasskeyCredential credential = 2;
}

message PasskeyVerifyResponse {
  bool   verified         = 1;
  string error            = 2;
  Session session         = 3;   // Issued on success
}

// ── API Key ─────────────────────────────────────────────────────
// For headless environments: CI, servers, automation.

message ApiKey {
  string id               = 1;   // Public identifier (prefix: qk_)
  bytes  key_hash         = 2;   // SHA-256 of the raw key (never store raw)
  string owner_id         = 3;   // User or service account that created it
  string label            = 4;   // Human-readable name
  repeated string scopes  = 5;   // Allowed operations (e.g. "proxy:read", "audit:write")
  google.protobuf.Timestamp created_at  = 6;
  google.protobuf.Timestamp expires_at  = 7;  // Optional expiry
  bool   revoked          = 8;
}

message ApiKeyCreateRequest {
  string label            = 1;
  repeated string scopes  = 2;
  int64  ttl_seconds      = 3;   // 0 = no expiry
}

message ApiKeyCreateResponse {
  string raw_key          = 1;   // Returned ONCE at creation — not stored
  ApiKey key              = 2;
}

message ApiKeyVerifyRequest {
  string raw_key          = 1;
}

message ApiKeyVerifyResponse {
  bool   valid            = 1;
  ApiKey key              = 2;   // Populated if valid
  string error            = 3;
}

// ── Session ─────────────────────────────────────────────────────
// Issued after successful auth (passkey or API key).
// In-memory by default, 24h max lifetime.

message Session {
  string id               = 1;   // Opaque session token (UUID v4)
  string subject_id       = 2;   // User or API key owner
  string auth_method      = 3;   // "passkey" | "api_key"
  repeated string scopes  = 4;   // Inherited from auth credential
  google.protobuf.Timestamp issued_at  = 5;
  google.protobuf.Timestamp expires_at = 6;  // Default: issued_at + 24h
  bool   revoked          = 7;
}

message SessionValidateRequest {
  string token            = 1;
}

message SessionValidateResponse {
  bool    valid           = 1;
  Session session         = 2;
  string  error           = 3;
}

// ── Signature verification (for audit entries) ──────────────────

message SignatureRequest {
  bytes  data             = 1;   // Canonical JSON bytes to sign
  bytes  private_key      = 2;   // Ed25519 PKCS8
}

message SignatureResponse {
  bytes  signature        = 1;   // Ed25519 signature
}

message SignatureVerifyRequest {
  bytes  data             = 1;
  bytes  signature        = 2;
  bytes  public_key       = 3;   // Ed25519 SPKI
}

message SignatureVerifyResponse {
  bool   valid            = 1;
}
