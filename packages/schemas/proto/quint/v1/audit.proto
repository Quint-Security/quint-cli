syntax = "proto3";

package quint.v1;

option go_package = "github.com/Quint-Security/quint/gen/quint/v1";

import "quint/v1/common.proto";

// ── Audit log entry ─────────────────────────────────────────────
// Each entry is signed and hash-chained to the previous entry.
// This is the core tamper-evident record of every MCP interaction.

message AuditEntry {
  int64     id             = 1;
  string    timestamp      = 2;   // ISO-8601
  string    server_name    = 3;
  Direction direction      = 4;
  string    method         = 5;   // JSON-RPC method (e.g. "tools/call")
  string    message_id     = 6;   // JSON-RPC id (stringified)
  string    tool_name      = 7;
  bytes     arguments_json = 8;   // Raw JSON of tool arguments
  bytes     response_json  = 9;   // Raw JSON of response body
  Verdict   verdict        = 10;

  // Integrity fields
  string    policy_hash    = 11;  // SHA-256 of canonical policy at time of entry
  string    prev_hash      = 12;  // SHA-256 of previous entry's signature
  string    nonce          = 13;  // UUID v4 replay protection
  bytes     signature      = 14;  // Ed25519 signature over canonical entry
  bytes     public_key     = 15;  // Signer's public key (SPKI)
}

// ── Verification result ─────────────────────────────────────────

message VerifyResult {
  int64  entry_id        = 1;
  bool   signature_valid = 2;
  bool   chain_valid     = 3;   // prev_hash matches sha256(prev.signature)
  string error           = 4;   // Human-readable error if invalid
}

message VerifyChainResult {
  int32  total_entries      = 1;
  int32  valid_signatures   = 2;
  int32  invalid_signatures = 3;
  int32  valid_links        = 4;
  int32  broken_links       = 5;
  repeated VerifyResult details = 6;
}
